{% from "keystone/map.jinja" import server with context %}
Listen 5000
Listen 35357

<VirtualHost *:5000>
	ServerName {{ grains['fqdn'] }}

	WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}
	WSGIProcessGroup keystone-public
	WSGIScriptAlias / /usr/bin/keystone-wsgi-public
	WSGIApplicationGroup %{GLOBAL}
	WSGIPassAuthorization On
	ErrorLogFormat "%{cu}t %M"
	ErrorLog /var/log/apache2/keystone.log
	CustomLog /var/log/apache2/keystone_access.log combined

	<Directory /usr/bin>
		Require all granted
	</Directory>

	{%- if server.websso.enabled %}
	WSGIScriptAliasMatch ^(/v3/OS-FEDERATION/identity_providers/.*?/protocols/.*?/auth)$ /usr/bin/keystone-wsgi-public/$1
        <Location /Shibboleth.sso>
          SetHandler shib
        </Location>
	<LocationMatch /v3/auth/OS-FEDERATION/identity_providers/.*?/protocols/saml2/websso>
	  ShibRequestSetting requireSession 1
	  AuthType shibboleth
	  ShibExportAssertion Off
	  Require valid-user
	</LocationMatch>
        <LocationMatch /v3/auth/OS-FEDERATION/websso/saml2>
          ShibRequestSetting requireSession 1
          AuthType shibboleth
          ShibExportAssertion Off
          Require valid-user
        </LocationMatch>
        <LocationMatch /v3/OS-FEDERATION/identity_providers/.*?/protocols/saml2/auth>
          ShibRequestSetting requireSession 1
          AuthType shibboleth
          ShibExportAssertion Off
          Require valid-user
        </LocationMatch>
	{%- endif %}

</VirtualHost>

<VirtualHost *:35357>
	ServerName {{ grains['fqdn'] }}

	WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}
	WSGIProcessGroup keystone-admin
	WSGIScriptAlias / /usr/bin/keystone-wsgi-admin
	WSGIApplicationGroup %{GLOBAL}
	WSGIPassAuthorization On
	ErrorLogFormat "%{cu}t %M"
	ErrorLog /var/log/apache2/keystone.log
	CustomLog /var/log/apache2/keystone_access.log combined

	<Directory /usr/bin>
		Require all granted
	</Directory>

	{%- if server.websso.enabled %}
        WSGIScriptAliasMatch ^(/v3/OS-FEDERATION/identity_providers/.*?/protocols/.*?/auth)$ /usr/bin/keystone-wsgi-admin/$1
	<Location /Shibboleth.sso>
	  SetHandler shib
	</Location>
        <LocationMatch /v3/auth/OS-FEDERATION/identity_providers/.*?/protocols/saml2/websso>
          ShibRequestSetting requireSession 1
          AuthType shibboleth
          ShibExportAssertion Off
          Require valid-user
        </LocationMatch>
        <LocationMatch /v3/auth/OS-FEDERATION/websso/saml2>
          ShibRequestSetting requireSession 1
          AuthType shibboleth
          ShibExportAssertion Off
          Require valid-user
        </LocationMatch>
        <LocationMatch /v3/OS-FEDERATION/identity_providers/.*?/protocols/saml2/auth>
          ShibRequestSetting requireSession 1
          AuthType shibboleth
          ShibExportAssertion Off
          Require valid-user
        </LocationMatch>
	{%- endif %}


</VirtualHost>
